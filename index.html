<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharos LeaseBridge | RWA Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #e2b053; --sky: #38bdf8; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: radial-gradient(circle at 20% 20%, #0f172a 0%, #020617 100%);
            color: #f1f5f9;
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gold-border { border: 1px solid rgba(226, 176, 83, 0.3); }
    </style>
</head>
<body class="p-4 md:p-8">

    <nav class="max-w-7xl mx-auto flex justify-between items-center mb-16 glass p-5 rounded-2xl shadow-2xl">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-yellow-200 rounded-lg flex items-center justify-center font-black text-slate-900">PL</div>
            <h1 class="text-xl font-extrabold tracking-tighter uppercase text-white">Pharos <span class="text-[#e2b053]">LeaseBridge</span></h1>
        </div>
        <button id="connectBtn" onclick="init()" class="bg-sky-600 hover:bg-sky-500 text-white px-8 py-2.5 rounded-xl font-bold transition-all text-sm">
            Connect Wallet
        </button>
    </nav>

    <main class="max-w-7xl mx-auto space-y-10">
        <section id="adminPanel" class="hidden">
            <div class="glass gold-border p-8 rounded-3xl">
                <h2 class="text-[10px] font-black text-[#e2b053] uppercase tracking-[0.4em] mb-6">Executive Asset Control</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <button onclick="withdrawFunds()" id="withdrawBtn" class="border border-amber-500/40 text-[#e2b053] py-3 rounded-xl font-bold text-xs">Withdraw Revenue</button>
                    <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="pName" type="text" placeholder="Asset Name" class="bg-slate-950 border border-white/10 p-4 rounded-xl text-sm outline-none">
                        <input id="pImg" type="text" placeholder="Image URL" class="bg-slate-950 border border-white/10 p-4 rounded-xl text-sm outline-none">
                        <button onclick="mintProperty()" id="mintBtn" class="bg-[#e2b053] text-black font-black py-4 rounded-xl uppercase text-xs">Register Asset</button>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-extrabold">Verified Assets</h2>
                <div id="statusIndicator" class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-red-600 rounded-full"></span> Disconnected
                </div>
            </div>
            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="col-span-full py-40 text-center glass rounded-[40px] text-slate-500">Connect wallet to begin.</div>
            </div>
        </section>
    </main>

    <script>
        const PHAROS_HEX_ID = "0xa8229"; // 688689
        const CONTRACT_ADDR = "0x8067fe980e975ba291752a57586dbeb09641e1c3";
        
        // Full params only used if the chain is missing
        const PHAROS_PARAMS = {
            chainId: PHAROS_HEX_ID,
            chainName: "Pharos Atlantic",
            rpcUrls: ["https://atlantic.dplabs-internal.com"],
            nativeCurrency: { name: "PHRS", symbol: "PHRS", decimals: 18 },
            blockExplorerUrls: ["https://atlantic.pharosscan.xyz/"]
        };

        const ABI = [
            "function owner() view returns (address)",
            "function mintProperty(string _name, string _image) external",
            "function rentProperty(uint256 _tokenId, uint64 _days) external payable",
            "function propertyInfo(uint256) view returns (string name, string imageUri, bool isVerified)",
            "function propertyRentals(uint256) view returns (address renter, uint64 expiry)",
            "function dailyRate() view returns (uint256)",
            "function nextTokenId() view returns (uint256)",
            "function withdraw() external"
        ];

        let provider, signer, contract;

        async function init() {
            if (!window.ethereum) return alert("Please open in OKX/MetaMask.");
            const btn = document.getElementById('connectBtn');

            try {
                // 1. INITIAL ETHEREUM CONNECTION
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // 2. CHECK NETWORK VIA CHAIN ID ONLY
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (currentChainId !== PHAROS_HEX_ID) {
                    try {
                        // TRY SWITCHING USING ONLY ID
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: PHAROS_HEX_ID }],
                        });
                    } catch (switchError) {
                        // ONLY IF SWITCH FAILS (CODE 4902), USE FULL PARAMS TO ADD
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [PHAROS_PARAMS],
                            });
                        } else { throw switchError; }
                    }
                }

                // 3. SET UP ETHERS AFTER NETWORK IS CONFIRMED
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                // 4. UI UPDATES
                btn.innerText = accounts[0].substring(0,6) + "..." + accounts[0].substring(38);
                btn.classList.replace('bg-sky-600', 'bg-emerald-600');
                document.getElementById('statusIndicator').innerHTML = `<span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> PHAROS LIVE`;

                const owner = await contract.owner();
                if(accounts[0].toLowerCase() === owner.toLowerCase()) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                }
                loadGallery();
            } catch (err) {
                console.error(err);
                btn.innerText = "Connect Wallet";
            }
        }

        async function loadGallery() {
            const gallery = document.getElementById('gallery');
            try {
                const total = await contract.nextTokenId();
                gallery.innerHTML = "";
                for (let i = 0; i < total; i++) {
                    const info = await contract.propertyInfo(i);
                    const rental = await contract.propertyRentals(i);
                    const active = Number(rental.expiry) > Math.floor(Date.now() / 1000);
                    gallery.innerHTML += `
                        <div class="glass rounded-[32px] overflow-hidden border border-white/5 p-4">
                            <img src="${info.imageUri}" class="w-full h-48 object-cover rounded-2xl mb-4" onerror="this.src='https://via.placeholder.com/400x200'">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold">${info.name}</h3>
                                <span class="text-[9px] font-bold ${active ? 'text-red-400' : 'text-emerald-400'}">${active ? 'RENTED' : 'AVAILABLE'}</span>
                            </div>
                            ${!active ? `
                                <input id="days-${i}" type="number" placeholder="Days" class="w-full bg-slate-950 border border-white/5 rounded-xl p-3 mb-2 outline-none text-xs">
                                <button onclick="rentAsset(${i})" class="w-full bg-sky-600 py-3 rounded-xl font-bold text-xs">Rent Now</button>
                            ` : `<div class="bg-white/5 p-3 rounded-xl text-center text-xs text-slate-400 font-mono">Expires: ${new Date(Number(rental.expiry) * 1000).toLocaleDateString()}</div>`}
                        </div>`;
                }
            } catch (e) { console.error(e); }
        }

        async function rentAsset(id) {
            const days = document.getElementById(`days-${id}`).value;
            if(!days) return;
            try {
                const rate = await contract.dailyRate();
                const tx = await contract.rentProperty(id, days, { value: rate * BigInt(days) });
                await tx.wait();
                loadGallery();
            } catch (e) { alert("Tx Failed"); }
        }

        async function mintProperty() {
            const name = document.getElementById('pName').value;
            const img = document.getElementById('pImg').value;
            try {
                const tx = await contract.mintProperty(name, img);
                await tx.wait();
                loadGallery();
            } catch (e) { alert("Admin Only"); }
        }

        async function withdrawFunds() {
            try {
                const tx = await contract.withdraw();
                await tx.wait();
                alert("Withdrawal Complete");
            } catch (e) { alert("Action Failed"); }
        }
    </script>
</body>
</html>
