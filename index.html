<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaseBridge | RWA Gallery</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <style>
        :root { --accent: #00f2ff; --purple: #7000ff; --bg: #050b14; --glass: rgba(255, 255, 255, 0.05); }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        .glass { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .btn { background: linear-gradient(45deg, var(--accent), var(--purple)); border: none; color: white; padding: 12px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
        
        /* Gallery Grid */
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 18px; overflow: hidden; transition: 0.3s; }
        .card:hover { border-color: var(--accent); transform: translateY(-5px); }
        .card-img { width: 100%; height: 160px; object-fit: cover; }
        .card-body { padding: 15px; }
        
        .status-badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; float: right; }
        .available { background: #10b981; }
        .rented { background: #ef4444; }

        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #333; background: #000; color: white; box-sizing: border-box; }
        #adminPanel { display: none; border: 1px dashed var(--accent); }
    </style>
</head>
<body>

    <div class="glass" style="text-align: center;">
        <h1 style="margin:0; background: linear-gradient(90deg, #00f2ff, #7000ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">PHAROS LEASEBRIDGE</h1>
        <p id="walletStatus" style="font-size: 12px; color: #888;">Wallet Not Connected</p>
        <button class="btn" id="connectBtn" onclick="connect()">Connect Wallet (OKX/MetaMask)</button>
    </div>

    <div id="adminPanel" class="glass">
        <h3 style="color:var(--accent); margin-top:0;">üõ°Ô∏è Owner: Add New Property</h3>
        <input type="text" id="pName" placeholder="Property Name (e.g. Luxury Beach House)">
        <input type="text" id="pImg" placeholder="Image URL (e.g. https://site.com/house.jpg)">
        <button class="btn" onclick="mintRWA()" style="background: #10b981;">Add to Marketplace</button>
    </div>

    <h2 style="margin-left: 10px;">üèôÔ∏è Available Assets</h2>
    <div id="gallery">
        <p style="padding: 20px; color: #666;">Connect wallet to load marketplace...</p>
    </div>

    <script>
        const CONTRACT_ADDR = "0x8067fe980e975ba291752a57586dbeb09641e1c3";
        const ABI = [
            "function mintProperty(string memory _name, string memory _image) external",
            "function rentProperty(uint256 _tokenId, uint64 _days) external payable",
            "function propertyInfo(uint256) public view returns (string name, string imageUri, bool isVerified)",
            "function propertyRentals(uint256) public view returns (address renter, uint64 expiry)",
            "function owner() public view returns (address)",
            "function dailyRate() public view returns (uint256)",
            "function nextTokenId() public view returns (uint256)"
        ];

        let signer, contract, userAddress;

        async function connect() {
            if (!window.ethereum) return alert("No wallet detected!");
            
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                document.getElementById('walletStatus').innerText = "Connected: " + userAddress.substring(0,8) + "...";
                document.getElementById('connectBtn').style.display = "none";

                // Check for Admin status
                const owner = await contract.owner();
                if (userAddress.toLowerCase() === owner.toLowerCase()) {
                    document.getElementById('adminPanel').style.display = "block";
                }

                loadGallery();
            } catch (err) { alert("Connection Error: " + err.message); }
        }

        async function loadGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = "<p>Scanning Pharos Blockchain...</p>";
            
            try {
                // Modified based on the public nextTokenId variable in contract
                // If you used the specific name nextTokenId in Step 1, use that:
                const total = await contract.nextTokenId(); 
                gallery.innerHTML = "";

                for (let i = 0; i < total; i++) {
                    const info = await contract.propertyInfo(i);
                    const rental = await contract.propertyRentals(i);
                    const now = Math.floor(Date.now() / 1000);
                    const isOccupied = rental.expiry > now;

                    const card = document.createElement('div');
                    card.className = "card";
                    card.innerHTML = `
                        <img src="${info.imageUri}" class="card-img" onerror="this.src='https://via.placeholder.com/300x160?text=Property+Image'">
                        <div class="card-body">
                            <span class="status-badge ${isOccupied ? 'rented' : 'available'}">${isOccupied ? 'Rented' : 'Available'}</span>
                            <h4 style="margin:0;">${info.name}</h4>
                            <p style="font-size:12px; color:#aaa;">ID: #${i}</p>
                            ${!isOccupied ? `
                                <input type="number" id="days-${i}" placeholder="Days" style="margin-bottom:10px;">
                                <button class="btn" onclick="rent(${i})">Rent Now</button>
                            ` : `
                                <div style="color:var(--accent); font-size:12px; font-weight:bold; margin-top:10px;">
                                    Occupied until: ${new Date(rental.expiry * 1000).toLocaleDateString()}
                                </div>
                            `}
                        </div>
                    `;
                    gallery.appendChild(card);
                }
            } catch (err) { gallery.innerHTML = "Error loading gallery. Ensure you are on Pharos Network."; }
        }

        async function rent(id) {
            const days = document.getElementById(`days-${id}`).value;
            if (!days || days < 1) return alert("Enter days");
            
            try {
                const rate = await contract.dailyRate();
                const cost = rate.mul(days);
                const tx = await contract.rentProperty(id, days, { value: cost });
                await tx.wait();
                alert("Success!");
                loadGallery(); // Refresh UI
            } catch (e) { alert("Error: " + e.message); }
        }

        async function mintRWA() {
            const name = document.getElementById('pName').value;
            const img = document.getElementById('pImg').value;
            try {
                const tx = await contract.mintProperty(name, img);
                await tx.wait();
                alert("New RWA Minted!");
                loadGallery();
            } catch (e) { alert("Mint Error: " + e.message); }
        }
    </script>
</body>
</html>
