<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharos Atlantic | Governance Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #0a192f 0%, #020617 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .pharos-glow {
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-4xl mx-auto flex justify-between items-center mb-12">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-sky-500 rounded-full flex items-center justify-center pharos-glow">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <h1 class="text-2xl font-bold tracking-tight text-sky-400">PHAROS <span class="text-white">ATLANTIC</span></h1>
        </div>
        <button id="connectBtn" class="bg-sky-600 hover:bg-sky-500 text-white px-6 py-2 rounded-lg font-semibold transition-all pharos-glow">
            Connect Wallet
        </button>
    </header>

    <main class="max-w-4xl mx-auto space-y-8">
        
        <div id="walletInfo" class="hidden text-right text-sm text-sky-300 italic">
            Connected: <span id="userAddress">0x...</span> | Network: <span id="networkName" class="font-bold">Loading...</span>
        </div>

        <section id="adminSection" class="hidden glass p-6 rounded-2xl">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-sky-400">
                <span class="w-2 h-2 bg-sky-400 rounded-full"></span> Create Proposal (Admin Only)
            </h2>
            <div class="flex gap-4">
                <input id="proposalTitle" type="text" placeholder="Describe your proposal..." class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-sky-500 text-white">
                <button onclick="createProposal()" class="bg-sky-600 hover:bg-sky-500 px-6 py-2 rounded-lg font-medium transition-colors">Submit</button>
            </div>
        </section>

        <section class="glass p-6 rounded-2xl">
            <h2 class="text-xl font-bold mb-6 text-white">Live Governance Proposals</h2>
            <div id="proposalList" class="space-y-4">
                <p class="text-slate-500 italic text-center py-8">Please connect your wallet to view active polls.</p>
            </div>
        </section>

    </main>

    <script>
        // NETWORK PARAMETERS (PHAROS ATLANTIC)
        const PHAROS_HEX_ID = "0xa8229"; // Hex for 688689
        const PHAROS_NETWORK = {
            chainId: PHAROS_HEX_ID,
            chainName: "Pharos Atlantic",
            rpcUrls: ["https://atlantic.dplabs-internal.com"],
            nativeCurrency: { name: "PHRS", symbol: "PHRS", decimals: 18 },
            blockExplorerUrls: ["https://atlantic.pharosscan.xyz/"]
        };

        const contractAddress = "0x807cd20e984a540810f67eac788f3618b889a285";
        const contractABI = [
            "function createProposal(string _title) external",
            "function vote(uint256 _id, bool _support) external",
            "function closeProposal(uint256 _id) external",
            "function proposalCount() view returns (uint256)",
            "function proposals(uint256) view returns (string title, uint256 yesVotes, uint256 noVotes, bool active)",
            "function admin() view returns (address)"
        ];

        let provider, signer, contract;

        async function connect() {
            if (!window.ethereum) return alert("MetaMask not found!");

            try {
                // 1. Initial Connection
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                const userAddr = accounts[0];

                // 2. CHECK & SWITCH NETWORK (Smooth Flow)
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (currentChainId !== PHAROS_HEX_ID) {
                    try {
                        // Try switching first
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: PHAROS_HEX_ID }],
                        });
                    } catch (switchError) {
                        // Error 4902 means the network is not added to the wallet
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [PHAROS_NETWORK],
                            });
                        } else {
                            throw switchError;
                        }
                    }
                    // Re-sync after switch
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                }

                // 3. INIT CONTRACT
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                // 4. UI UPDATE
                document.getElementById('userAddress').innerText = userAddr.substring(0,6) + "..." + userAddr.substring(38);
                document.getElementById('networkName').innerText = "Pharos Atlantic";
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectBtn').innerText = "Wallet Linked";
                document.getElementById('connectBtn').classList.replace('bg-sky-600', 'bg-green-600');
                
                // Show Admin Panel if Owner
                const adminAddr = await contract.admin();
                if(userAddr.toLowerCase() === adminAddr.toLowerCase()) {
                    document.getElementById('adminSection').classList.remove('hidden');
                }

                loadProposals();
            } catch (err) {
                console.error(err);
                if (err.code === 4001) alert("Connection rejected.");
            }
        }

        async function loadProposals() {
            const list = document.getElementById('proposalList');
            try {
                const count = await contract.proposalCount();
                list.innerHTML = "";
                if (count == 0) {
                    list.innerHTML = "<p class='text-center text-slate-500'>No proposals found yet.</p>";
                    return;
                }

                for (let i = 1; i <= count; i++) {
                    const p = await contract.proposals(i);
                    list.innerHTML += `
                        <div class="bg-slate-900/60 border border-slate-800 p-6 rounded-xl shadow-xl transition-all hover:border-sky-900">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <span class="text-xs font-mono text-sky-500 uppercase tracking-widest">Proposal #${i}</span>
                                    <h3 class="text-xl font-semibold text-white mt-1">${p.title}</h3>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${p.active ? 'bg-green-500/10 text-green-400 border border-green-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'}">
                                    ${p.active ? '● OPEN' : '● CLOSED'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-slate-800/40 p-3 rounded-lg text-center">
                                    <p class="text-slate-400 text-xs uppercase">Yes</p>
                                    <p class="text-xl font-bold text-green-400">${p.yesVotes.toString()}</p>
                                </div>
                                <div class="bg-slate-800/40 p-3 rounded-lg text-center">
                                    <p class="text-slate-400 text-xs uppercase">No</p>
                                    <p class="text-xl font-bold text-red-400">${p.noVotes.toString()}</p>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                ${p.active ? `
                                    <button onclick="vote(${i}, true)" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg font-semibold transition-all">VOTE YES</button>
                                    <button onclick="vote(${i}, false)" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg font-semibold transition-all">VOTE NO</button>
                                ` : `<div class="w-full text-center py-2 bg-slate-800 rounded-lg text-slate-500 font-medium">Voting Finalized</div>`}
                            </div>
                        </div>`;
                }
            } catch (err) { console.error(err); }
        }

        async function createProposal() {
            const title = document.getElementById('proposalTitle').value;
            if(!title) return;
            const tx = await contract.createProposal(title);
            await tx.wait();
            loadProposals();
        }

        async function vote(id, support) {
            const tx = await contract.vote(id, support);
            await tx.wait();
            loadProposals();
        }

        document.getElementById('connectBtn').addEventListener('click', connect);
    </script>
</body>
</html>
