<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharos LeaseBridge | RWA Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #e2b053; --sky: #38bdf8; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: radial-gradient(circle at 20% 20%, #0f172a 0%, #020617 100%);
            color: #f1f5f9;
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gold-border { border: 1px solid rgba(226, 176, 83, 0.3); }
        .sky-glow:hover { box-shadow: 0 0 20px rgba(56, 189, 248, 0.3); }
    </style>
</head>
<body class="p-4 md:p-8">

    <nav class="max-w-7xl mx-auto flex justify-between items-center mb-16 glass p-5 rounded-2xl shadow-2xl">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-yellow-200 rounded-lg flex items-center justify-center font-black text-slate-900">PL</div>
            <h1 class="text-xl font-extrabold tracking-tighter uppercase">Pharos <span class="text-[#e2b053]">LeaseBridge</span></h1>
        </div>
        <button id="connectBtn" onclick="init()" class="bg-sky-600 hover:bg-sky-500 text-white px-8 py-2.5 rounded-xl font-bold transition-all sky-glow text-sm tracking-tight">
            Connect Wallet
        </button>
    </nav>

    <main class="max-w-7xl mx-auto space-y-10">
        
        <section id="adminPanel" class="hidden">
            <div class="glass gold-border p-8 rounded-3xl relative overflow-hidden">
                <h2 class="text-[10px] font-black text-[#e2b053] uppercase tracking-[0.4em] mb-6 flex items-center gap-2">
                    <span class="w-2 h-2 bg-[#e2b053] rounded-full"></span> Executive Asset Control
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="md:col-span-1 space-y-4">
                        <button onclick="withdrawFunds()" id="withdrawBtn" class="w-full border border-amber-500/40 hover:bg-amber-500/10 text-[#e2b053] py-3 rounded-xl font-bold transition-all text-xs">
                            Withdraw Revenue
                        </button>
                    </div>
                    <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="pName" type="text" placeholder="Asset Name" class="bg-slate-950/80 border border-white/10 p-4 rounded-xl focus:border-amber-500 outline-none text-sm">
                        <input id="pImg" type="text" placeholder="Image URL" class="bg-slate-950/80 border border-white/10 p-4 rounded-xl focus:border-amber-500 outline-none text-sm">
                        <button onclick="mintProperty()" id="mintBtn" class="bg-[#e2b053] hover:bg-yellow-500 text-black font-black py-4 rounded-xl transition-all uppercase text-xs">Register Asset</button>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-extrabold tracking-tight">Verified Assets</h2>
                <div id="statusIndicator" class="text-[10px] font-bold text-slate-500 flex items-center gap-2 border border-white/5 px-4 py-2 rounded-full uppercase">
                    <span class="w-1.5 h-1.5 bg-red-600 rounded-full"></span> Disconnected
                </div>
            </div>

            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="col-span-full py-40 text-center glass rounded-[40px] border-dashed border-white/10">
                    <p class="text-slate-500 text-sm font-medium">Connect wallet to Pharos Atlantic to access registry.</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        const CONFIG = {
            network: {
                chainId: "0xa8229", // 688689
                chainName: "Pharos Atlantic",
                rpcUrls: ["https://atlantic.dplabs-internal.com"],
                nativeCurrency: { name: "PHRS", symbol: "PHRS", decimals: 18 },
                blockExplorerUrls: ["https://atlantic.pharosscan.xyz/"]
            },
            address: "0x8067fe980e975ba291752a57586dbeb09641e1c3",
            abi: [
                "function owner() view returns (address)",
                "function mintProperty(string _name, string _image) external",
                "function rentProperty(uint256 _tokenId, uint64 _days) external payable",
                "function propertyInfo(uint256) view returns (string name, string imageUri, bool isVerified)",
                "function propertyRentals(uint256) view returns (address renter, uint64 expiry)",
                "function dailyRate() view returns (uint256)",
                "function nextTokenId() view returns (uint256)",
                "function withdraw() external"
            ]
        };

        let provider, signer, contract;

        async function init() {
            if (!window.ethereum) return alert("Wallet not found. Use OKX or MetaMask browser.");
            const btn = document.getElementById('connectBtn');
            
            try {
                // 1. SILENT SWITCH (Try switch first, only Add if missing)
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CONFIG.network.chainId }],
                    });
                } catch (e) {
                    if (e.code === 4902) {
                        // Only add if 4902 (Chain not found)
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [CONFIG.network],
                        });
                    } else { throw e; }
                }

                // 2. CONNECT ACCOUNTS
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // 3. INIT ETHERS
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONFIG.address, CONFIG.abi, signer);

                // 4. UI UPDATES
                const userAddr = accounts[0];
                btn.innerText = userAddr.substring(0,6) + "..." + userAddr.substring(38);
                btn.classList.replace('bg-sky-600', 'bg-emerald-600');
                document.getElementById('statusIndicator').innerHTML = `<span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> PHRS LIVE`;

                // 5. ADMIN CHECK
                const owner = await contract.owner();
                if(userAddr.toLowerCase() === owner.toLowerCase()) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                }
                loadGallery();
            } catch (err) {
                console.error(err);
                if(err.code === 4001) alert("User rejected connection.");
            }
        }

        async function loadGallery() {
            const gallery = document.getElementById('gallery');
            try {
                const total = await contract.nextTokenId();
                gallery.innerHTML = "";
                if (Number(total) === 0) {
                    gallery.innerHTML = `<div class="col-span-full py-20 text-center text-slate-500 italic">No assets registered.</div>`;
                    return;
                }
                for (let i = 0; i < total; i++) {
                    const info = await contract.propertyInfo(i);
                    const rental = await contract.propertyRentals(i);
                    const active = Number(rental.expiry) > Math.floor(Date.now() / 1000);
                    gallery.innerHTML += `
                        <div class="glass rounded-[32px] overflow-hidden border border-white/5">
                            <img src="${info.imageUri}" class="w-full h-60 object-cover" onerror="this.src='https://via.placeholder.com/400x250?text=Property'">
                            <div class="p-6 space-y-4">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-bold text-lg">${info.name}</h3>
                                    <span class="text-[10px] font-bold ${active ? 'text-red-400' : 'text-emerald-400'}">
                                        ${active ? '● RENTED' : '● AVAILABLE'}
                                    </span>
                                </div>
                                ${!active ? `
                                    <input id="days-${i}" type="number" placeholder="Days" class="w-full bg-slate-950 border border-white/5 rounded-xl px-4 py-3 text-xs outline-none focus:border-sky-500">
                                    <button onclick="rentAsset(${i})" class="w-full bg-sky-600 py-3 rounded-xl font-bold text-xs">Rent Property</button>
                                ` : `
                                    <div class="bg-sky-500/5 p-4 rounded-xl text-center">
                                        <p class="text-[9px] text-slate-500 uppercase">Lease Ends</p>
                                        <p class="text-sm font-medium">${new Date(Number(rental.expiry) * 1000).toLocaleDateString()}</p>
                                    </div>
                                `}
                            </div>
                        </div>`;
                }
            } catch (e) { console.error(e); }
        }

        async function rentAsset(id) {
            const days = document.getElementById(`days-${id}`).value;
            if(!days) return;
            try {
                const rate = await contract.dailyRate();
                const tx = await contract.rentProperty(id, days, { value: rate * BigInt(days), gasLimit: 300000 });
                await tx.wait();
                loadGallery();
            } catch (e) { alert("Transaction Failed"); }
        }

        async function mintProperty() {
            const name = document.getElementById('pName').value;
            const img = document.getElementById('pImg').value;
            const btn = document.getElementById('mintBtn');
            try {
                btn.innerText = "...";
                const tx = await contract.mintProperty(name, img, { gasLimit: 400000 });
                await tx.wait();
                loadGallery();
            } catch (e) { alert("Admin Error"); }
            finally { btn.innerText = "Register Asset"; }
        }

        async function withdrawFunds() {
            try {
                const tx = await contract.withdraw({ gasLimit: 150000 });
                await tx.wait();
                alert("Withdrawal Complete");
            } catch (e) { alert("Admin Only"); }
        }
    </script>
</body>
</html>
