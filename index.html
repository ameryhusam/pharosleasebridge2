<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharos LeaseBridge | RWA Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #0f172a; 
            --secondary: #1e293b; 
            --accent: #3b82f6; 
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #f1f5f9; 
            --border: rgba(255, 255, 255, 0.1); 
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, var(--primary), #020617);
            color: var(--text);
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto flex justify-between items-center mb-12 glass p-6 rounded-2xl shadow-xl">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white text-xl shadow-lg">LB</div>
            <h1 class="text-2xl font-bold">Pharos LeaseBridge</h1>
        </div>
        <button id="connectBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-semibold transition-all shadow-md hover:shadow-lg">
            Connect Wallet
        </button>
    </header>

    <main class="max-w-7xl mx-auto space-y-12">
        
        <div id="walletInfo" class="hidden text-right text-sm text-blue-400 font-medium">
            Connected as: <span id="userAddress" class="text-white font-mono">0x...</span>
        </div>

        <section id="adminSection" class="hidden glass p-8 rounded-2xl shadow-xl">
            <h2 class="text-xl font-semibold mb-6">Admin Panel: Asset Registration</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <button onclick="withdrawFunds()" class="border border-blue-500/50 text-blue-400 py-4 rounded-lg font-semibold hover:bg-blue-500/10 transition-all hover-lift">Withdraw Revenue</button>
                <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input id="pName" type="text" placeholder="Property Name" class="bg-transparent border border-gray-600 p-4 rounded-lg text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition-all">
                    <input id="pImg" type="text" placeholder="Image URL (High-Res)" class="bg-transparent border border-gray-600 p-4 rounded-lg text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition-all">
                    <button onclick="mintProperty()" id="mintBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-4 rounded-lg transition-all shadow-md hover:shadow-lg hover-lift">Deploy RWA</button>
                </div>
            </div>
        </section>

        <section>
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold">Global RWA Registry</h2>
                <div class="px-5 py-2 bg-gray-800 rounded-full text-sm font-medium text-gray-400 shadow-inner">
                    Network: Pharos Atlantic
                </div>
            </div>
            
            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="col-span-full py-24 text-center glass rounded-2xl shadow-xl">
                    <div class="inline-block w-8 h-8 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-400 text-base font-medium">Syncing with blockchain...</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        // CONFIGURATION
        const PHAROS_HEX_ID = "0xa8229"; 
        const CONTRACT_ADDR = "0x8067fe980e975ba291752a57586dbeb09641e1c3";
        const RPC_URL = "https://atlantic.dplabs-internal.com";

        const ABI = [
            "function owner() view returns (address)",
            "function mintProperty(string _name, string _image) external",
            "function rentProperty(uint256 _tokenId, uint64 _days) external payable",
            "function propertyInfo(uint256) view returns (string name, string imageUri, bool isVerified)",
            "function propertyRentals(uint256) view returns (address renter, uint64 expiry)",
            "function dailyRate() view returns (uint256)",
            "function nextTokenId() view returns (uint256)",
            "function withdraw() external"
        ];

        let provider, signer, contract;

        // 1. SMART BOOT: Fetch RWA data immediately using public RPC
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const readOnlyProvider = new ethers.JsonRpcProvider(RPC_URL);
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDR, ABI, readOnlyProvider);
                await refreshGallery(readOnlyContract);
            } catch (e) {
                console.error("RPC Sync Error:", e);
                document.getElementById('gallery').innerHTML = `<p class="col-span-full text-center text-red-400 py-12 text-lg font-medium">Connection error. Please verify network or contract deployment.</p>`;
            }
        });

        // 2. SMOOTH CONNECT: Accounts first, then switch
        async function connect() {
            if (!window.ethereum) return alert("Web3 Wallet not found.");
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                const userAddr = accounts[0];

                // Network Handshake
                const network = await provider.getNetwork();
                if (network.chainId !== BigInt(688689)) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: PHAROS_HEX_ID }],
                        });
                        provider = new ethers.BrowserProvider(window.ethereum);
                        signer = await provider.getSigner();
                    } catch (err) {
                        if (err.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: PHAROS_HEX_ID,
                                    chainName: 'Pharos Atlantic Testnet',
                                    rpcUrls: [RPC_URL],
                                    nativeCurrency: { name: 'PHRS', symbol: 'PHRS', decimals: 18 },
                                    blockExplorerUrls: ['https://pharos-testnet.socialscan.io/']
                                }],
                            });
                        }
                    }
                }

                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
                
                // UI Refresh
                document.getElementById('userAddress').innerText = userAddr.slice(0,6) + '...' + userAddr.slice(-4);
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectBtn').innerText = "Connected";
                document.getElementById('connectBtn').classList.add('bg-green-600', 'hover:bg-green-500');

                // Admin Security Check
                const ownerAddr = await contract.owner();
                const adminPanel = document.getElementById('adminSection');
                if (userAddr.toLowerCase() === ownerAddr.toLowerCase()) {
                    adminPanel.classList.remove('hidden');
                } else {
                    adminPanel.classList.add('hidden');
                }

                refreshGallery(contract);
            } catch (e) {
                console.error("Connect error:", e);
                alert("Connection failed: " + e.message);
            }
        }

        // 3. CORE LOGIC: Using all Smart Contract Properties
        async function refreshGallery(targetContract) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = "";
            try {
                const count = Number(await targetContract.nextTokenId());
                const rate = await targetContract.dailyRate();
                const formattedRate = ethers.formatEther(rate);
                const now = Math.floor(Date.now() / 1000);
                
                if (count <= 1) {
                    gallery.innerHTML = `<p class="col-span-full text-center text-gray-400 py-12 text-lg font-medium glass rounded-2xl shadow-xl">No assets registered yet. Admin can deploy new RWAs.</p>`;
                    return;
                }

                for (let i = 1; i < count; i++) {
                    try {
                        const info = await targetContract.propertyInfo(i);
                        const rental = await targetContract.propertyRentals(i);
                        const isRented = Number(rental.expiry) > now;
                        const isVerified = info.isVerified ? '<span class="ml-2 text-green-400">âœ“ Verified</span>' : '';

                        gallery.innerHTML += `
                            <div class="glass rounded-2xl overflow-hidden flex flex-col p-5 shadow-lg hover-lift">
                                <div class="relative overflow-hidden rounded-xl mb-4">
                                    <img src="${info.imageUri}" class="w-full h-56 object-cover transition-transform duration-500 hover:scale-105" onerror="this.src='https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=800'">
                                    <div class="absolute top-3 right-3 bg-gray-900/70 px-3 py-1 rounded-full text-xs font-semibold text-white">
                                        ${isRented ? 'Leased' : 'Available'}
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-xl">\( {info.name} \){isVerified}</h3>
                                    <span class="text-sm text-blue-400 bg-blue-400/10 px-3 py-1 rounded-full font-medium">${formattedRate} PHRS/Day</span>
                                </div>

                                ${!isRented ? `
                                    <div class="mt-auto space-y-3">
                                        <input id="days-${i}" type="number" min="1" placeholder="Lease Duration (Days)" 
                                            oninput="calcInvoice(${i}, ${formattedRate})"
                                            class="w-full bg-transparent border border-gray-600 p-3 rounded-lg text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition-all">
                                        <div id="inv-${i}" class="text-sm text-gray-400 font-medium">Total: 0.00 PHRS</div>
                                        <button onclick="rentAsset(${i})" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-semibold transition-all shadow-md hover:shadow-lg">Secure Lease</button>
                                    </div>
                                ` : `
                                    <div class="mt-auto bg-gray-800/50 p-5 rounded-xl border border-gray-700">
                                        <p class="text-xs text-gray-400 font-semibold uppercase mb-2">Lease Active Until</p>
                                        <p class="text-base font-semibold text-orange-400">${new Date(Number(rental.expiry) * 1000).toLocaleString()}</p>
                                        <div class="mt-3 w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                            <div class="bg-orange-400 h-full" style="width: ${((Number(rental.expiry) - now) / (86400 * 30)) * 100}%"></div> <!-- Approximate progress -->
                                        </div>
                                    </div>
                                `}
                            </div>`;
                    } catch (err) {
                        console.warn(`Failed to load asset ${i}:`, err);
                    }
                }
                if (gallery.innerHTML === "") {
                    gallery.innerHTML = `<p class="col-span-full text-center text-gray-400 py-12 text-lg font-medium glass rounded-2xl shadow-xl">No assets available. Please check contract deployment or mint new RWAs.</p>`;
                }
            } catch (err) { 
                console.error("Gallery Render Failed:", err); 
                gallery.innerHTML = `<p class="col-span-full text-center text-red-400 py-12 text-lg font-medium glass rounded-2xl shadow-xl">Failed to load assets. This may be due to contract not being deployed at the specified address or network issues.</p>`;
            }
        }

        // 4. INTERACTION HELPERS
        function calcInvoice(id, rate) {
            const val = document.getElementById(`days-${id}`).value || 0;
            document.getElementById(`inv-${id}`).innerText = `Total: ${(val * rate).toFixed(2)} PHRS`;
        }

        async function rentAsset(id) {
            if (!contract) return connect();
            const days = document.getElementById(`days-${id}`).value;
            if (!days || days <= 0) return alert("Please enter a valid number of days.");
            
            try {
                const rate = await contract.dailyRate();
                const total = rate * BigInt(days);
                const tx = await contract.rentProperty(id, days, { value: total });
                await tx.wait();
                alert("Lease successful!");
                refreshGallery(contract);
            } catch (e) { alert("Lease failed: " + (e.reason || e.message)); }
        }

        async function mintProperty() {
            const name = document.getElementById('pName').value;
            const img = document.getElementById('pImg').value;
            if (!name || !img) return alert("Please fill all fields.");
            
            const btn = document.getElementById('mintBtn');
            try {
                btn.innerText = "Deploying...";
                btn.disabled = true;
                const tx = await contract.mintProperty(name, img);
                await tx.wait();
                alert("RWA deployed successfully!");
                document.getElementById('pName').value = "";
                document.getElementById('pImg').value = "";
                refreshGallery(contract);
            } catch (e) { alert("Deployment failed: " + (e.reason || e.message)); }
            finally { 
                btn.innerText = "Deploy RWA";
                btn.disabled = false;
            }
        }

        async function withdrawFunds() {
            try {
                const tx = await contract.withdraw();
                await tx.wait();
                alert("Withdrawal successful.");
            } catch (e) { alert("Withdrawal failed: " + (e.reason || e.message)); }
        }

        // EVENT LISTENERS
        document.getElementById('connectBtn').addEventListener('click', connect);

        if (window.ethereum) {
            window.ethereum.on('accountsChanged', connect);
            window.ethereum.on('chainChanged', () => window.location.reload());
        }
    </script>
</body>
</html>
