<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaseBridge | Admin Corrected</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="min-h-screen">

    <nav class="p-6 max-w-7xl mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-bold text-sky-400">PHAROS LEASEBRIDGE</h1>
        <button id="connectBtn" onclick="init()" class="bg-sky-600 hover:bg-sky-500 px-6 py-2 rounded-xl font-bold transition-all shadow-lg">
            Connect Wallet
        </button>
    </nav>

    <main class="max-w-7xl mx-auto px-6 mt-10 space-y-10">
        
        <section id="adminPanel" class="hidden glass p-8 rounded-3xl border-2 border-amber-500/30">
            <h2 class="text-sm font-bold mb-6 text-amber-500 uppercase tracking-widest">üõ°Ô∏è Owner Control Panel</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <input id="pName" type="text" placeholder="Asset Name" class="bg-slate-900 border border-slate-700 p-3 rounded-xl focus:border-sky-500 outline-none">
                <input id="pImg" type="text" placeholder="Direct Image URL" class="bg-slate-900 border border-slate-700 p-3 rounded-xl focus:border-sky-500 outline-none">
                <button onclick="mintProperty()" id="mintBtn" class="bg-amber-600 hover:bg-amber-500 py-3 rounded-xl font-bold transition-all">MINT RWA</button>
            </div>
        </section>

        <section>
            <h2 class="text-3xl font-bold mb-8 text-white">Verified Asset Collection</h2>
            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="col-span-full py-20 text-center glass rounded-3xl text-slate-500">
                    Connect to Pharos Atlantic to view available properties.
                </div>
            </div>
        </section>
    </main>

    <script>
        const PHAROS_CHAIN_ID = '0x1f4'; // 500
        const CONTRACT_ADDR = "0x8067fe980e975ba291752a57586dbeb09641e1c3";
        const ABI = [
            "function mintProperty(string _name, string _image) external",
            "function rentProperty(uint256 _tokenId, uint64 _days) external payable",
            "function propertyInfo(uint256) view returns (string name, string imageUri, bool isVerified)",
            "function propertyRentals(uint256) view returns (address renter, uint64 expiry)",
            "function owner() view returns (address)",
            "function dailyRate() view returns (uint256)",
            "function nextTokenId() view returns (uint256)"
        ];

        let provider, signer, contract;

        async function init() {
            if (!window.ethereum) return alert("Please use a Web3 browser (OKX/MetaMask)");

            try {
                // Force Switch
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: PHAROS_CHAIN_ID }],
                });

                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                const userAddr = accounts[0];
                document.getElementById('connectBtn').innerText = userAddr.substring(0,6) + "..." + userAddr.substring(38);
                document.getElementById('connectBtn').classList.replace('bg-sky-600', 'bg-emerald-600');

                // FIXED ADMIN CHECK: Case-insensitive comparison
                const contractOwner = await contract.owner();
                console.log("Contract Owner:", contractOwner);
                console.log("Connected User:", userAddr);

                if(userAddr.toLowerCase() === contractOwner.toLowerCase()) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                }

                loadGallery();
            } catch (err) { console.error(err); }
        }

        async function loadGallery() {
            const gallery = document.getElementById('gallery');
            try {
                const total = await contract.nextTokenId();
                gallery.innerHTML = "";

                if (Number(total) === 0) {
                    gallery.innerHTML = `<div class="col-span-full py-20 glass rounded-3xl text-center text-slate-500 italic">Marketplace empty. Admin must mint assets.</div>`;
                    return;
                }

                for (let i = 0; i < total; i++) {
                    const info = await contract.propertyInfo(i);
                    const rental = await contract.propertyRentals(i);
                    const isOccupied = Number(rental.expiry) > Math.floor(Date.now() / 1000);

                    gallery.innerHTML += `
                        <div class="glass rounded-3xl overflow-hidden border border-slate-700">
                            <img src="${info.imageUri}" class="w-full h-52 object-cover" onerror="this.src='https://via.placeholder.com/400x200?text=Property+Asset'">
                            <div class="p-6">
                                <h3 class="text-xl font-bold mb-4">${info.name}</h3>
                                ${!isOccupied ? `
                                    <input id="days-${i}" type="number" placeholder="Days" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-2
                                    
