<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharos LeaseBridge | RWA Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #e2b053; --sky: #38bdf8; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: radial-gradient(circle at 20% 20%, #0f172a 0%, #020617 100%);
            color: #f1f5f9;
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .gold-border { border: 1px solid rgba(226, 176, 83, 0.3); }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto flex justify-between items-center mb-12 glass p-5 rounded-2xl">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-amber-500 rounded-lg flex items-center justify-center font-black text-slate-900">LB</div>
            <h1 class="text-xl font-extrabold tracking-tighter uppercase">Pharos <span class="text-[#e2b053]">LeaseBridge</span></h1>
        </div>
        <button id="connectBtn" class="bg-sky-600 hover:bg-sky-500 text-white px-6 py-2 rounded-xl font-bold transition-all text-sm">
            Connect Wallet
        </button>
    </header>

    <main class="max-w-7xl mx-auto space-y-10">
        <div id="walletInfo" class="hidden text-right text-sm text-sky-300 italic">
            Connected: <span id="userAddress">0x...</span>
        </div>

        <section id="adminSection" class="hidden glass gold-border p-8 rounded-3xl animate-in fade-in slide-in-from-top-4 duration-500">
            <h2 class="text-[10px] font-black text-[#e2b053] uppercase tracking-[0.4em] mb-6 flex items-center gap-2">
                <span class="w-2 h-2 bg-[#e2b053] rounded-full"></span> Executive Asset Control
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <button onclick="withdrawFunds()" id="withdrawBtn" class="border border-amber-500/40 text-[#e2b053] py-3 rounded-xl font-bold text-xs hover:bg-amber-500/10 transition-all">Withdraw Revenue</button>
                <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input id="pName" type="text" placeholder="Asset Name" class="bg-slate-950/80 border border-white/10 p-4 rounded-xl text-sm outline-none focus:border-amber-500">
                    <input id="pImg" type="text" placeholder="Image URL" class="bg-slate-950/80 border border-white/10 p-4 rounded-xl text-sm outline-none focus:border-amber-500">
                    <button onclick="mintProperty()" id="mintBtn" class="bg-[#e2b053] hover:bg-yellow-500 text-black font-black py-4 rounded-xl transition-all uppercase text-xs">Register RWA</button>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-3xl font-extrabold tracking-tight mb-8">Verified Property Gallery</h2>
            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p class="col-span-full text-center text-slate-500 italic py-20 glass rounded-3xl">Connect wallet to view active leases.</p>
            </div>
        </section>
    </main>

    <script>
        const PHAROS_HEX_ID = "0xa8229"; // 688689
        const CONTRACT_ADDR = "0x8067fe980e975ba291752a57586dbeb09641e1c3";
        const ABI = [
            "function owner() view returns (address)",
            "function mintProperty(string _name, string _image) external",
            "function rentProperty(uint256 _tokenId, uint64 _days) external payable",
            "function propertyInfo(uint256) view returns (string name, string imageUri, bool isVerified)",
            "function propertyRentals(uint256) view returns (address renter, uint64 expiry)",
            "function dailyRate() view returns (uint256)",
            "function nextTokenId() view returns (uint256)",
            "function withdraw() external"
        ];

        let provider, signer, contract;

        // --- THE "SMOOTH" CONNECT LOGIC ---
        async function connect() {
            if (window.ethereum) {
                try {
                    // 1. Establish initial wallet link
                    provider = new ethers.BrowserProvider(window.ethereum);
                    const accounts = await provider.send("eth_requestAccounts", []);
                    signer = await provider.getSigner();
                    const addr = accounts[0];

                    // 2. Network Check (Only switch if wrong)
                    const network = await provider.getNetwork();
                    if (network.chainId !== BigInt(688689)) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: PHAROS_HEX_ID }],
                            });
                            // Refresh provider after switch
                            provider = new ethers.BrowserProvider(window.ethereum);
                            signer = await provider.getSigner();
                        } catch (err) {
                            if (err.code === 4902) alert("Please add Pharos Atlantic to your wallet.");
                        }
                    }

                    contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                    // 3. UI Update
                    document.getElementById('userAddress').innerText = addr.substring(0,6) + "..." + addr.substring(38);
                    document.getElementById('walletInfo').classList.remove('hidden');
                    document.getElementById('connectBtn').innerText = "Wallet Linked";
                    document.getElementById('connectBtn').classList.replace('bg-sky-600', 'bg-emerald-600');

                    // 4. Admin Check
                    const contractOwner = await contract.owner();
                    if (addr.toLowerCase() === contractOwner.toLowerCase()) {
                        document.getElementById('adminSection').classList.remove('hidden');
                    }

                    loadGallery();
                } catch (err) {
                    console.error(err);
                    alert("Connection failed.");
                }
            } else {
                alert("Web3 wallet not found.");
            }
        }

        async function loadGallery() {
            const list = document.getElementById('gallery');
            try {
                const count = await contract.nextTokenId();
                list.innerHTML = "";
                if (Number(count) === 0) {
                    list.innerHTML = "<p class='col-span-full text-center text-slate-500'>No properties found.</p>";
                    return;
                }

                for (let i = 0; i < Number(count); i++) {
                    const info = await contract.propertyInfo(i);
                    const rental = await contract.propertyRentals(i);
                    const isRented = Number(rental.expiry) > Math.floor(Date.now() / 1000);

                    list.innerHTML += `
                        <div class="glass rounded-[32px] overflow-hidden border border-white/5 transition-all hover:border-[#e2b053]/30">
                            <img src="${info.imageUri}" class="w-full h-52 object-cover" onerror="this.src='https://via.placeholder.com/400x200'">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg">${info.name}</h3>
                                    <span class="text-[10px] font-bold ${isRented ? 'text-red-400' : 'text-emerald-400'}">
                                        ${isRented ? '● OCCUPIED' : '● AVAILABLE'}
                                    </span>
                                </div>
                                ${!isRented ? `
                                    <input id="days-${i}" type="number" placeholder="Duration (Days)" class="w-full bg-slate-950 border border-white/10 rounded-xl p-3 mb-2 outline-none text-sm focus:border-sky-500">
                                    <button onclick="rentAsset(${i})" class="w-full bg-sky-600 py-3 rounded-xl font-bold text-xs uppercase tracking-widest">Sign Lease</button>
                                ` : `
                                    <div class="bg-sky-500/10 p-4 rounded-xl text-center">
                                        <p class="text-[9px] text-sky-400 uppercase font-black">Expiry Date</p>
                                        <p class="text-sm font-medium">${new Date(Number(rental.expiry) * 1000).toLocaleDateString()}</p>
                                    </div>
                                `}
                            </div>
                        </div>`;
                }
            } catch (err) { console.error(err); }
        }

        async function rentAsset(id) {
            const days = document.getElementById(`days-${id}`).value;
            if(!days) return alert("Enter days");
            try {
                const rate = await contract.dailyRate();
                const tx = await contract.rentProperty(id, days, { value: rate * BigInt(days) });
                await tx.wait();
                loadGallery();
            } catch (err) { alert("Tx failed."); }
        }

        async function mintProperty() {
            const name = document.getElementById('pName').value;
            const img = document.getElementById('pImg').value;
            try {
                const tx = await contract.mintProperty(name, img);
                await tx.wait();
                loadGallery();
            } catch (err) { alert("Admin Only"); }
        }

        async function withdrawFunds() {
            try {
                const tx = await contract.withdraw();
                await tx.wait();
                alert("Withdrawal successful.");
            } catch (err) { alert("Action failed."); }
        }

        document.getElementById('connectBtn').addEventListener('click', connect);
    </script>
</body>
</html>
