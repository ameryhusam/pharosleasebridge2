<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharos LeaseBridge | RWA Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #0f172a; 
            --secondary: #1e293b; 
            --accent: #3b82f6; 
            --text: #f1f5f9; 
            --border: rgba(255, 255, 255, 0.1); 
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-7xl mx-auto flex justify-between items-center mb-12 glass p-6 rounded-xl shadow-lg">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-md flex items-center justify-center font-bold text-white shadow-md">LB</div>
            <h1 class="text-xl font-semibold">Pharos LeaseBridge</h1>
        </div>
        <button id="connectBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-md font-medium transition-all shadow-md">
            Connect Wallet
        </button>
    </header>

    <main class="max-w-7xl mx-auto space-y-10">
        
        <div id="walletInfo" class="hidden text-right text-sm text-blue-400">
            Connected: <span id="userAddress" class="text-white">0x...</span>
        </div>

        <section id="adminSection" class="hidden glass p-6 rounded-xl shadow-lg">
            <h2 class="text-lg font-semibold mb-6">Admin: Register New Asset</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <button onclick="withdrawFunds()" class="border border-blue-500/50 text-blue-400 py-3 rounded-md font-medium hover:bg-blue-500/10 transition-all">Withdraw Revenue</button>
                <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input id="pName" type="text" placeholder="Property Name" class="bg-transparent border border-gray-600 p-3 rounded-md text-sm outline-none focus:border-blue-500 transition-colors">
                    <input id="pImg" type="text" placeholder="Image URL" class="bg-transparent border border-gray-600 p-3 rounded-md text-sm outline-none focus:border-blue-500 transition-colors">
                    <button onclick="mintProperty()" id="mintBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 rounded-md transition-all shadow-md">Deploy Asset</button>
                </div>
            </div>
        </section>

        <section>
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-2xl font-semibold">RWA Registry</h2>
                <div class="px-4 py-1 bg-gray-800 rounded-full text-xs font-medium text-gray-400">
                    Network: Pharos Atlantic
                </div>
            </div>
            
            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full py-20 text-center glass rounded-xl">
                    <div class="inline-block w-6 h-6 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-500 text-sm">Loading assets...</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        // CONFIGURATION
        const PHAROS_HEX_ID = "0xa8229"; 
        const CONTRACT_ADDR = "0x8067fe980e975ba291752a57586dbeb09641e1c3";
        const RPC_URL = "https://atlantic.dplabs-internal.com";

        const ABI = [
            "function owner() view returns (address)",
            "function mintProperty(string _name, string _image) external",
            "function rentProperty(uint256 _tokenId, uint64 _days) external payable",
            "function propertyInfo(uint256) view returns (string name, string imageUri, bool isVerified)",
            "function propertyRentals(uint256) view returns (address renter, uint64 expiry)",
            "function dailyRate() view returns (uint256)",
            "function nextTokenId() view returns (uint256)",
            "function withdraw() external"
        ];

        let provider, signer, contract;

        // 1. SMART BOOT: Fetch RWA data immediately using public RPC
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const readOnlyProvider = new ethers.JsonRpcProvider(RPC_URL);
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDR, ABI, readOnlyProvider);
                await refreshGallery(readOnlyContract);
            } catch (e) {
                console.error("RPC Sync Error:", e);
                document.getElementById('gallery').innerHTML = `<p class="col-span-full text-center text-red-400 py-10">Connection error. Please check network.</p>`;
            }
        });

        // 2. SMOOTH CONNECT: Accounts first, then switch
        async function connect() {
            if (!window.ethereum) return alert("Web3 Wallet not found.");
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                const userAddr = accounts[0];

                // Network Handshake
                const network = await provider.getNetwork();
                if (network.chainId !== BigInt(688689)) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: PHAROS_HEX_ID }],
                        });
                        provider = new ethers.BrowserProvider(window.ethereum);
                        signer = await provider.getSigner();
                    } catch (err) {
                        if (err.code === 4902) alert("Add Pharos Atlantic Testnet to your wallet.");
                    }
                }

                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
                
                // UI Refresh
                document.getElementById('userAddress').innerText = userAddr.slice(0,6) + '...' + userAddr.slice(-4);
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectBtn').innerText = "Connected";
                document.getElementById('connectBtn').classList.replace('bg-blue-600', 'bg-green-600');

                // Admin Security Check
                const ownerAddr = await contract.owner();
                const adminPanel = document.getElementById('adminSection');
                if (userAddr.toLowerCase() === ownerAddr.toLowerCase()) {
                    adminPanel.classList.remove('hidden');
                } else {
                    adminPanel.classList.add('hidden');
                }

                refreshGallery(contract);
            } catch (e) {
                console.error("Connect error:", e);
            }
        }

        // 3. CORE LOGIC: Using all Smart Contract Properties
        async function refreshGallery(targetContract) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = "";
            try {
                const count = Number(await targetContract.nextTokenId());
                const rate = await targetContract.dailyRate();
                const formattedRate = ethers.formatEther(rate);
                const now = Math.floor(Date.now() / 1000);
                
                if (count === 1) {  // Assuming nextTokenId starts at 1 with no tokens
                    gallery.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10 glass rounded-xl">No assets available yet.</p>`;
                    return;
                }

                for (let i = 1; i < count; i++) {  // Start from 1 assuming token IDs begin at 1
                    try {
                        const info = await targetContract.propertyInfo(i);
                        const rental = await targetContract.propertyRentals(i);
                        const isRented = Number(rental.expiry) > now;

                        gallery.innerHTML += `
                            <div class="glass rounded-xl overflow-hidden flex flex-col p-4 shadow-md hover:shadow-lg transition-shadow">
                                <div class="relative overflow-hidden rounded-md mb-4">
                                    <img src="${info.imageUri}" class="w-full h-48 object-cover transition-transform hover:scale-105" onerror="this.src='https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=800'">
                                    <div class="absolute top-2 right-2 bg-gray-800 px-2 py-1 rounded text-xs font-medium text-white">
                                        ${isRented ? 'Leased' : 'Available'}
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="font-semibold text-lg">${info.name}</h3>
                                    <span class="text-xs text-blue-400 bg-blue-400/10 px-2 py-1 rounded">${formattedRate} PHRS/Day</span>
                                </div>

                                ${!isRented ? `
                                    <div class="mt-auto space-y-2">
                                        <input id="days-${i}" type="number" placeholder="Days" min="1"
                                            oninput="calcInvoice(${i}, ${formattedRate})"
                                            class="w-full bg-transparent border border-gray-600 p-2 rounded text-sm outline-none focus:border-blue-500">
                                        <div id="inv-${i}" class="text-xs text-gray-400">Total: 0.00 PHRS</div>
                                        <button onclick="rentAsset(${i})" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-medium transition-all">Lease Asset</button>
                                    </div>
                                ` : `
                                    <div class="mt-auto bg-gray-800 p-4 rounded-md">
                                        <p class="text-xs text-gray-400 mb-1">Active Until</p>
                                        <p class="text-sm font-medium text-orange-400">${new Date(Number(rental.expiry) * 1000).toLocaleString()}</p>
                                    </div>
                                `}
                            </div>`;
                    } catch (err) {
                        console.warn(`Failed to load asset ${i}:`, err);
                    }
                }
                if (gallery.innerHTML === "") {
                    gallery.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10 glass rounded-xl">No assets available yet.</p>`;
                }
            } catch (err) { 
                console.error("Gallery Render Failed:", err); 
                gallery.innerHTML = `<p class="col-span-full text-center text-red-400 py-10">Failed to load assets.</p>`;
            }
        }

        // 4. INTERACTION HELPERS
        function calcInvoice(id, rate) {
            const val = document.getElementById(`days-${id}`).value;
            document.getElementById(`inv-${id}`).innerText = `Total: ${(val * rate).toFixed(2)} PHRS`;
        }

        async function rentAsset(id) {
            if (!contract) return connect();
            const days = document.getElementById(`days-${id}`).value;
            if (!days || days <= 0) return alert("Please enter a valid number of days.");
            
            try {
                const rate = await contract.dailyRate();
                const total = rate * BigInt(days);
                const tx = await contract.rentProperty(id, days, { value: total });
                await tx.wait();
                refreshGallery(contract);
            } catch (e) { alert("Lease failed: " + e.message); }
        }

        async function mintProperty() {
            const name = document.getElementById('pName').value;
            const img = document.getElementById('pImg').value;
            if (!name || !img) return alert("Please fill all fields.");
            
            const btn = document.getElementById('mintBtn');
            try {
                btn.innerText = "Deploying...";
                btn.disabled = true;
                const tx = await contract.mintProperty(name, img);
                await tx.wait();
                document.getElementById('pName').value = "";
                document.getElementById('pImg').value = "";
                refreshGallery(contract);
            } catch (e) { alert("Deployment failed: " + e.message); }
            finally { 
                btn.innerText = "Deploy Asset";
                btn.disabled = false;
            }
        }

        async function withdrawFunds() {
            try {
                const tx = await contract.withdraw();
                await tx.wait();
                alert("Withdrawal successful.");
            } catch (e) { alert("Withdrawal failed: " + e.message); }
        }

        // EVENT LISTENERS
        document.getElementById('connectBtn').addEventListener('click', connect);

        if (window.ethereum) {
            window.ethereum.on('accountsChanged', connect);
            window.ethereum.on('chainChanged', () => window.location.reload());
        }
    </script>
</body>
</html>
