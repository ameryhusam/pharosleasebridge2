<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeaseBridge | Premium RWA</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Outfit:wght@300;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #e2b053; --bg: #030508; --card: #0a0e14; --glow: rgba(226, 176, 83, 0.2); }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Outfit', sans-serif; overflow-x: hidden; }
        
        /* Interactive Background */
        .bg-glow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #030508 100%); z-index: -1; }

        /* Navigation */
        nav { padding: 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo { font-family: 'Cinzel', serif; font-size: 24px; color: var(--gold); letter-spacing: 3px; }

        /* Hero Section */
        .hero { display: flex; flex-wrap: wrap; padding: 60px 5%; align-items: center; gap: 40px; min-height: 60vh; }
        .hero-text { flex: 1; min-width: 300px; }
        .hero-text h1 { font-family: 'Cinzel', serif; font-size: 4rem; margin: 0; line-height: 1; }
        .hero-text p { font-size: 1.2rem; color: #8a8a8a; margin: 20px 0; max-width: 500px; }

        /* Animated Connect Button */
        .btn-connect { 
            background: none; border: 2px solid var(--gold); color: var(--gold); 
            padding: 18px 40px; border-radius: 0; font-weight: 800; cursor: pointer;
            transition: 0.4s; position: relative; overflow: hidden;
        }
        .btn-connect:hover { background: var(--gold); color: black; box-shadow: 0 0 30px var(--glow); }

        /* Marketplace Gallery */
        .section-title { padding-left: 5%; font-family: 'Cinzel', serif; font-size: 2rem; color: var(--gold); }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 40px; padding: 40px 5%; }
        
        .prop-card { 
            background: var(--card); border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 0; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .prop-card:hover { transform: scale(1.02); border-color: var(--gold); }
        .prop-img { width: 100%; height: 400px; object-fit: cover; filter: grayscale(40%); transition: 0.5s; }
        .prop-card:hover .prop-img { filter: grayscale(0%); }
        
        .prop-overlay { padding: 25px; background: linear-gradient(0deg, var(--card) 0%, transparent 100%); margin-top: -100px; position: relative; }
        
        .status { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--gold); margin-bottom: 10px; }
        input { background: transparent; border: 1px solid #333; color: white; padding: 15px; width: 100%; box-sizing: border-box; margin: 15px 0; }
        
        #adminPanel { display: none; padding: 50px 5%; background: #000; margin: 40px 5%; border: 1px solid var(--gold); }
    </style>
</head>
<body>
    <div class="bg-glow"></div>

    <nav>
        <div class="logo">PHAROS.LB</div>
        <div id="addr" style="font-size: 12px; opacity: 0.5;">0x00...00</div>
    </nav>

    <section class="hero">
        <div class="hero-text">
            <div class="status" style="margin-bottom: 20px;">Real World Asset Protocol</div>
            <h1>Prime Real Estate,<br><span style="color: var(--gold)">On-Chain</span></h1>
            <p>Access high-yield rental properties globally with instant liquidity on Pharos Atlantic.</p>
            <button class="btn-connect" id="conBtn" onclick="smartConnect()">AUTHORIZE WALLET</button>
        </div>
    </section>

    <div id="adminPanel">
        <h2 style="font-family: 'Cinzel'; color: var(--gold);">EXECUTIVE PORTAL</h2>
        <input type="text" id="mName" placeholder="ASSET NAME">
        <input type="text" id="mImg" placeholder="IMAGE URL">
        <button class="btn-connect" onclick="mint()">MINT TO REGISTRY</button>
    </div>

    <div class="section-title">THE COLLECTION</div>
    <div id="gallery" class="gallery">
        </div>

    <script>
        const CONTRACT_ADDR = "0x8067fe980e975ba291752a57586dbeb09641e1c3";
        const ABI = [
            "function mintProperty(string memory _name, string memory _image) external",
            "function rentProperty(uint256 _tokenId, uint64 _days) external payable",
            "function propertyInfo(uint256) public view returns (string name, string imageUri, bool isVerified)",
            "function propertyRentals(uint256) public view returns (address renter, uint64 expiry)",
            "function owner() public view returns (address)",
            "function dailyRate() public view returns (uint256)",
            "function nextTokenId() public view returns (uint256)"
        ];

        let provider, signer, contract;

        async function smartConnect() {
            const btn = document.getElementById('conBtn');
            btn.innerText = "REQUESTING ACCESS...";

            // ADVANCED PROVIDER DETECTION
            let walletProvider;
            if (window.ethereum) {
                if (window.ethereum.providers) {
                    walletProvider = window.ethereum.providers.find(p => p.isOKXWallet) || 
                                     window.ethereum.providers.find(p => p.isMetaMask) || 
                                     window.ethereum;
                } else {
                    walletProvider = window.ethereum;
                }
            }

            if (!walletProvider) {
                alert("Please access this via OKX or MetaMask Browser");
                btn.innerText = "AUTHORIZE WALLET";
                return;
            }

            try {
                // FORCE ACCOUNT HANDSHAKE
                const accounts = await walletProvider.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(walletProvider);
                signer = provider.getSigner();
                const userAddr = accounts[0];
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                document.getElementById('addr').innerText = userAddr;
                btn.style.display = "none";

                const owner = await contract.owner();
                if (userAddr.toLowerCase() === owner.toLowerCase()) {
                    document.getElementById('adminPanel').style.display = "block";
                }
                loadAssets();
            } catch (e) {
                console.error(e);
                btn.innerText = "AUTHORIZE WALLET";
                alert("Connection failed: User denied or Timeout.");
            }
        }

        async function loadAssets() {
            const gallery = document.getElementById('gallery');
            try {
                const total = await contract.nextTokenId();
                gallery.innerHTML = "";
                for(let i=0; i<total; i++) {
                    const info = await contract.propertyInfo(i);
                    const rent = await contract.propertyRentals(i);
                    const isRented = rent.expiry > (Date.now()/1000);

                    gallery.innerHTML += `
                        <div class="prop-card">
                            <img src="${info.imageUri}" class="prop-img">
                            <div class="prop-overlay">
                                <div class="status">${isRented ? 'Lease Active' : 'Registry: Available'}</div>
                                <h3 style="margin:0; font-family:'Cinzel'">${info.name}</h3>
                                ${!isRented ? `
                                    <input type="number" id="d-${i}" placeholder="Lease Duration (Days)">
                                    <button class="btn-connect" style="width:100%;" onclick="lease(${i})">SIGN LEASE</button>
                                ` : `<p style="color:var(--gold)">Leased until: ${new Date(rent.expiry*1000).toLocaleDateString()}</p>`}
                            </div>
                        </div>
                    `;
                }
            } catch(e) {}
        }

        async function lease(id) {
            const days = document.getElementById(`d-${id}`).value;
            try {
                const rate = await contract.dailyRate();
                const tx = await contract.rentProperty(id, days, { value: rate.mul(days) });
                await tx.wait();
                loadAssets();
            } catch(e) { alert("Lease Failed: Check Gas/Balance"); }
        }

        async function mint() {
            const n = document.getElementById('mName').value;
            const i = document.getElementById('mImg').value;
            try {
                const tx = await contract.mintProperty(n, i);
                await tx.wait();
                loadAssets();
            } catch(e) { alert("Mint Failed"); }
        }
    </script>
</body>
</html>
