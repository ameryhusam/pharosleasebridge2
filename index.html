<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharos LeaseBridge | Decentralized RWA Leasing Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #0f172a; 
            --secondary: #1e293b; 
            --accent: #3b82f6; 
            --gold: #d97706; 
            --success: #10b981; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --text: #f1f5f9; 
            --border: rgba(255, 255, 255, 0.1); 
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, var(--primary), #020617);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2); }
        .beacon-bg {
            background: radial-gradient(circle at 50% 30%, rgba(59, 130, 246, 0.3) 0%, transparent 70%),
                        url('https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?auto=format&fit=crop&w=1920&q=80') no-repeat center/cover;
            background-blend-mode: overlay;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="relative">

    <!-- Background Beacon Effect -->
    <div class="fixed inset-0 z-0 pointer-events-none opacity-20">
        <div class="absolute top-0 left-1/2 w-96 h-96 bg-blue-500 rounded-full filter blur-3xl animate-pulse-slow"></div>
    </div>

    <header class="relative z-10 max-w-7xl mx-auto flex justify-between items-center py-6 px-4 md:px-8">
        <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="w-12 h-12">
                <path fill="#3b82f6" d="M24 4L4 20v24h40V20L24 4z"/>
                <path fill="#d97706" d="M24 4l20 16v24H4V20L24 4zM24 12l-12 8v16h24V20l-12-8z"/>
                <circle fill="#fff" cx="24" cy="28" r="4"/>
                <path fill="#3b82f6" d="M20 40h8v4h-8z"/>
            </svg>
            <h1 class="text-2xl font-bold tracking-tight">Pharos LeaseBridge</h1>
        </div>
        <button id="connectBtn" class="bg-accent hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold transition-all shadow-md hover:shadow-lg md:px-8 md:py-3">
            Connect Wallet
        </button>
    </header>

    <main class="relative z-10 max-w-7xl mx-auto px-4 md:px-8 space-y-16">

        <!-- Hero -->
        <section class="beacon-bg glass rounded-3xl p-8 md:p-12 text-center shadow-2xl">
            <h2 class="text-4xl md:text-5xl font-extrabold mb-4 leading-tight">Bridge Real World Assets to the Blockchain</h2>
            <p class="text-lg md:text-xl text-gray-300 mb-8 max-w-3xl mx-auto">Secure leasing of premium RWAs on Pharos Atlantic – transparent, decentralized, investor-friendly.</p>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <a href="#gallery" class="bg-gold hover:bg-amber-600 text-white px-8 py-3 rounded-lg font-semibold transition-all">Explore Assets</a>
                <a href="#about" class="border border-accent text-accent px-8 py-3 rounded-lg font-semibold hover:bg-accent/10 transition-all">Learn More</a>
            </div>
        </section>

        <!-- Wallet Info -->
        <div id="walletInfo" class="hidden text-right text-sm text-accent font-medium">
            Connected: <span id="userAddress" class="font-mono">0x...</span> | <span id="isAdmin" class="text-gold"></span>
        </div>

        <!-- Admin Panel -->
        <section id="adminSection" class="hidden glass p-8 rounded-3xl shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Admin Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="glass p-6 rounded-2xl">
                    <h3 class="font-semibold mb-4">Mint New RWA</h3>
                    <input id="pName" type="text" placeholder="Property Name" class="w-full bg-transparent border border-gray-600 p-3 rounded-lg text-sm mb-3 outline-none focus:border-accent">
                    <input id="pImg" type="text" placeholder="Image URL" class="w-full bg-transparent border border-gray-600 p-3 rounded-lg text-sm mb-3 outline-none focus:border-accent">
                    <button onclick="mintProperty()" id="mintBtn" class="w-full bg-accent hover:bg-blue-500 text-white py-3 rounded-lg font-semibold transition-all">Deploy RWA</button>
                </div>
                <!-- Other admin controls remain the same -->
                <!-- ... (verify, pause, withdraw etc.) ... -->
            </div>
        </section>

        <!-- Gallery -->
        <section id="gallery">
            <h2 class="text-3xl font-bold mb-8">RWA Registry</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="assetGrid">
                <div class="col-span-full py-24 text-center glass rounded-3xl shadow-xl">
                    <div class="inline-block w-8 h-8 border-4 border-accent/30 border-t-accent rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-400 text-base font-medium">Syncing with Pharos Ledger...</p>
                </div>
            </div>
        </section>

    </main>

    <script>
        // ────────────────────────────────────────────────────────────────────────────────
        // CONFIG
        // ────────────────────────────────────────────────────────────────────────────────
        const PHAROS_HEX_ID = "0xa8229";
        const CONTRACT_ADDR = "0xC4F832c8bC9393B1430e53Cd4C43eB2D5D3291BF";
        const RPC_URL = "https://atlantic.dplabs-internal.com";

        const ABI = [
            // your full ABI here – make sure it matches your deployed contract
            "function owner() view returns (address)",
            "function mintProperty(string _name, string _image) external",
            "function rentProperty(uint256 tokenId, uint64 daysToRent) external payable",
            "function propertyInfo(uint256) view returns (string name, string imageUri, bool isVerified, uint256 dailyRate)",
            "function propertyRentals(uint256) view returns (address renter, uint64 expiry)",
            "function nextTokenId() view returns (uint256)",
            "function isRented(uint256) view returns (bool)",
            "function getRentalInfo(uint256) view returns (address renter, uint64 expiry)"
            // add more as needed (verify, pause, withdraw, etc.)
        ];

        let provider, signer, contract, userAddr;

        // ────────────────────────────────────────────────────────────────────────────────
        // LOAD ON START
        // ────────────────────────────────────────────────────────────────────────────────
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const readOnlyProvider = new ethers.JsonRpcProvider(RPC_URL);
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDR, ABI, readOnlyProvider);
                await refreshGallery(readOnlyContract);
            } catch (err) {
                console.error(err);
                document.getElementById('assetGrid').innerHTML = 
                    `<p class="col-span-full text-center text-red-400 py-12 text-lg">Connection error</p>`;
            }
        });

        // ────────────────────────────────────────────────────────────────────────────────
        // CONNECT WALLET
        // ────────────────────────────────────────────────────────────────────────────────
        async function connect() {
            if (!window.ethereum) return alert("Please install MetaMask or compatible wallet.");
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddr = accounts[0];

                const network = await provider.getNetwork();
                if (network.chainId !== BigInt(688689)) {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: PHAROS_HEX_ID }],
                    });
                }

                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                document.getElementById('userAddress').innerText = userAddr.slice(0,6) + '...' + userAddr.slice(-4);
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectBtn').innerText = "Connected";
                document.getElementById('connectBtn').classList.add('bg-green-600');

                const owner = await contract.owner();
                if (userAddr.toLowerCase() === owner.toLowerCase()) {
                    document.getElementById('adminSection').classList.remove('hidden');
                    document.getElementById('isAdmin').innerText = "(Admin)";
                }

                await refreshGallery(contract);
            } catch (e) {
                console.error(e);
                alert("Connection failed: " + (e.message || "Unknown error"));
            }
        }

        // ────────────────────────────────────────────────────────────────────────────────
        // GALLERY REFRESH – FIXED TYPE HANDLING
        // ────────────────────────────────────────────────────────────────────────────────
        async function refreshGallery(targetContract) {
            const grid = document.getElementById('assetGrid');
            grid.innerHTML = "";

            try {
                const count = Number(await targetContract.nextTokenId());
                const now = Math.floor(Date.now() / 1000);

                if (count <= 1) {
                    grid.innerHTML = `<p class="col-span-full text-center text-gray-400 py-12 text-lg font-medium glass rounded-3xl">No assets yet</p>`;
                    return;
                }

                for (let i = 1; i < count; i++) {
                    const info = await targetContract.propertyInfo(i);
                    const rental = await targetContract.getRentalInfo(i);
                    const isRentedNow = await targetContract.isRented(i);

                    const rateWei = info.dailyRate;                     // BigInt
                    const rateFormatted = ethers.formatEther(rateWei);  // string e.g. "0.01"
                    const rateNumber = Number(rateFormatted);           // safe number for math

                    const expiryDate = rental.expiry > 0 
                        ? new Date(Number(rental.expiry) * 1000).toLocaleString() 
                        : "Not rented";

                    grid.innerHTML += `
                        <div class="glass rounded-3xl overflow-hidden flex flex-col p-6 shadow-xl hover-lift">
                            <img src="${info.imageUri}" class="w-full h-56 object-cover rounded-2xl mb-4" 
                                 onerror="this.src='https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=800'">
                            <h3 class="font-bold text-xl mb-2">${info.name} ${info.isVerified ? '<span class="text-green-400 text-sm">✓ Verified</span>' : ''}</h3>
                            <p class="text-sm text-gray-400 mb-4">Daily Rate: ${rateFormatted} PHRS</p>

                            ${isRentedNow ? `
                                <div class="bg-gray-800/50 p-4 rounded-2xl">
                                    <p class="text-sm">Rented until: ${expiryDate}</p>
                                    ${rental.renter.toLowerCase() === userAddr?.toLowerCase() ? `
                                        <input id="extendDays-${i}" type="number" min="1" placeholder="Extend (days)" 
                                            oninput="updateInvoice(\( {i}, ' \){rateFormatted}', 'extend')"
                                            class="w-full mt-3 bg-transparent border border-gray-600 p-2 rounded text-sm outline-none focus:border-accent">
                                        <div id="extendInv-${i}" class="text-sm text-gray-400 mt-1">Total: 0.00 PHRS</div>
                                        <button onclick="extendRental(${i})" class="w-full mt-3 bg-yellow-600 hover:bg-yellow-500 text-white py-2 rounded font-semibold">Extend Lease</button>
                                    ` : '<p class="text-yellow-400 text-sm mt-2">Currently leased</p>'}
                                </div>
                            ` : `
                                <input id="days-${i}" type="number" min="1" placeholder="Lease duration (days)" 
                                    oninput="updateInvoice(\( {i}, ' \){rateFormatted}')"
                                    class="w-full bg-transparent border border-gray-600 p-3 rounded text-sm mb-2 outline-none focus:border-accent">
                                <div id="inv-${i}" class="text-sm text-gray-400 mb-3">Total: 0.00 PHRS</div>
                                <button onclick="rentAsset(${i})" class="w-full bg-accent hover:bg-blue-500 text-white py-3 rounded-lg font-semibold transition-all">Lease Now</button>
                            `}
                        </div>`;
                }
            } catch (err) {
                console.error("Gallery error:", err);
                grid.innerHTML = `<p class="col-span-full text-center text-red-400 py-12 text-lg font-medium glass rounded-3xl">Error: ${err.message}</p>`;
            }
        }

        // ────────────────────────────────────────────────────────────────────────────────
        // SAFE INVOICE CALCULATION
        // ────────────────────────────────────────────────────────────────────────────────
        function updateInvoice(tokenId, rateStr, prefix = '') {
            const daysEl = document.getElementById(`\( {prefix}Days- \){tokenId}`);
            const invEl  = document.getElementById(`\( {prefix}Inv- \){tokenId}`);

            if (!daysEl || !invEl) return;

            const days = Number(daysEl.value) || 0;
            const rate = Number(rateStr) || 0;

            const total = days * rate;
            invEl.innerText = `Total: ${total.toFixed(2)} PHRS`;
        }

        // ────────────────────────────────────────────────────────────────────────────────
        // RENT & EXTEND (BigInt only in ethers calls)
        // ────────────────────────────────────────────────────────────────────────────────
        async function rentAsset(tokenId) {
            if (!contract) return connect();
            const daysEl = document.getElementById(`days-${tokenId}`);
            const days = Number(daysEl?.value) || 0;
            if (days <= 0) return alert("Enter a valid number of days");

            try {
                const rateWei = (await contract.propertyInfo(tokenId)).dailyRate;
                const totalWei = rateWei * BigInt(days);
                const tx = await contract.rentProperty(tokenId, days, { value: totalWei });
                await tx.wait();
                alert("Lease successful!");
                refreshGallery(contract);
            } catch (e) {
                alert("Rent failed: " + (e.reason || e.message));
            }
        }

        async function extendRental(tokenId) {
            if (!contract) return connect();
            const daysEl = document.getElementById(`extendDays-${tokenId}`);
            const days = Number(daysEl?.value) || 0;
            if (days <= 0) return alert("Enter a valid number of days");

            try {
                const rateWei = (await contract.propertyInfo(tokenId)).dailyRate;
                const totalWei = rateWei * BigInt(days);
                const tx = await contract.extendRental(tokenId, days, { value: totalWei });
                await tx.wait();
                alert("Extension successful!");
                refreshGallery(contract);
            } catch (e) {
                alert("Extension failed: " + (e.reason || e.message));
            }
        }

        // ────────────────────────────────────────────────────────────────────────────────
        // MINT (simplified – add dailyRate input if your contract supports it)
        // ────────────────────────────────────────────────────────────────────────────────
        async function mintProperty() {
            const name = document.getElementById('pName')?.value?.trim();
            const img  = document.getElementById('pImg')?.value?.trim();

            if (!name || !img) return alert("Please fill name and image URL");

            try {
                const btn = document.getElementById('mintBtn');
                btn.disabled = true;
                btn.innerText = "Deploying...";

                const tx = await contract.mintProperty(name, img);
                await tx.wait();

                document.getElementById('pName').value = "";
                document.getElementById('pImg').value = "";
                alert("Asset minted successfully!");
                refreshGallery(contract);
            } catch (e) {
                alert("Mint failed: " + (e.reason || e.message));
            } finally {
                const btn = document.getElementById('mintBtn');
                btn.disabled = false;
                btn.innerText = "Deploy RWA";
            }
        }

        // ────────────────────────────────────────────────────────────────────────────────
        // EVENT LISTENERS
        // ────────────────────────────────────────────────────────────────────────────────
        document.getElementById('connectBtn').addEventListener('click', connect);

        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => connect());
            window.ethereum.on('chainChanged', () => location.reload());
        }
    </script>
</body>
</html>
