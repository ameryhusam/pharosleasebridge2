<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharos LeaseBridge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="p-6">

    <nav class="max-w-7xl mx-auto flex justify-between items-center mb-10 glass p-5 rounded-2xl">
        <h1 class="text-xl font-bold tracking-tighter">PHAROS <span class="text-amber-500">LEASEBRIDGE</span></h1>
        <button id="connectBtn" onclick="init()" class="bg-sky-600 hover:bg-sky-500 px-6 py-2 rounded-xl font-bold transition-all">
            Connect Wallet
        </button>
    </nav>

    <section id="adminPanel" class="hidden max-w-7xl mx-auto mb-10 glass border border-amber-500/30 p-8 rounded-3xl">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <button onclick="withdrawFunds()" class="border border-amber-500 text-amber-500 py-3 rounded-xl font-bold">Withdraw PHRS</button>
            <input id="pName" type="text" placeholder="Asset Name" class="bg-slate-900 p-3 rounded-xl outline-none border border-white/10">
            <input id="pImg" type="text" placeholder="Image URL" class="bg-slate-900 p-3 rounded-xl outline-none border border-white/10">
            <button onclick="mintProperty()" class="bg-amber-500 text-black font-bold py-3 rounded-xl">Mint Asset</button>
        </div>
    </section>

    <main class="max-w-7xl mx-auto">
        <div id="gallery" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-20 glass rounded-3xl text-slate-500">Connect wallet to load registry.</div>
        </div>
    </main>

    <script>
        const PHAROS_ID_HEX = "0xa8229"; // 688689
        const CONTRACT_ADDR = "0x8067fe980e975ba291752a57586dbeb09641e1c3";
        const PHAROS_PARAMS = {
            chainId: PHAROS_ID_HEX,
            chainName: "Pharos Atlantic",
            rpcUrls: ["https://atlantic.dplabs-internal.com"],
            nativeCurrency: { name: "PHRS", symbol: "PHRS", decimals: 18 },
            blockExplorerUrls: ["https://atlantic.pharosscan.xyz/"]
        };

        const ABI = [
            "function owner() view returns (address)",
            "function mintProperty(string _name, string _image) external",
            "function rentProperty(uint256 _tokenId, uint64 _days) external payable",
            "function propertyInfo(uint256) view returns (string name, string imageUri, bool isVerified)",
            "function propertyRentals(uint256) view returns (address renter, uint64 expiry)",
            "function dailyRate() view returns (uint256)",
            "function nextTokenId() view returns (uint256)",
            "function withdraw() external"
        ];

        let provider, signer, contract;

        async function init() {
            if (!window.ethereum) return alert("Please use a Web3 Browser");
            const btn = document.getElementById('connectBtn');

            try {
                // STEP 1: CONNECT TO CURRENT CHAIN (ANY CHAIN)
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const userAddr = accounts[0];

                // STEP 2: CHECK CHAIN ID
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });

                // STEP 3: ONLY POPUP IF NOT ON PHAROS
                if (currentChainId !== PHAROS_ID_HEX) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: PHAROS_ID_HEX }],
                        });
                    } catch (err) {
                        if (err.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [PHAROS_PARAMS],
                            });
                        }
                    }
                }

                // STEP 4: PROCEED WITH CONTRACT LOGIC
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                // UI Update
                btn.innerText = userAddr.substring(0,6) + "..." + userAddr.substring(38);
                btn.classList.replace('bg-sky-600', 'bg-emerald-600');

                // Admin Logic
                const owner = await contract.owner();
                if(userAddr.toLowerCase() === owner.toLowerCase()) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                }

                loadGallery();
            } catch (error) {
                console.error("Connection failed", error);
            }
        }

        async function loadGallery() {
            const gallery = document.getElementById('gallery');
            try {
                const total = await contract.nextTokenId();
                gallery.innerHTML = "";
                for (let i = 0; i < total; i++) {
                    const info = await contract.propertyInfo(i);
                    const rental = await contract.propertyRentals(i);
                    const isRented = Number(rental.expiry) > Math.floor(Date.now() / 1000);
                    gallery.innerHTML += `
                        <div class="glass p-4 rounded-3xl border border-white/5">
                            <img src="${info.imageUri}" class="w-full h-48 object-cover rounded-2xl mb-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold">${info.name}</h3>
                                <span class="text-[10px] font-bold ${isRented ? 'text-red-400' : 'text-emerald-400'}">
                                    ${isRented ? 'OCCUPIED' : 'AVAILABLE'}
                                </span>
                            </div>
                            ${!isRented ? `
                                <input id="days-${i}" type="number" placeholder="Days" class="w-full bg-slate-900 border border-white/10 p-3 rounded-xl mb-2 outline-none text-sm">
                                <button onclick="rentAsset(${i})" class="w-full bg-sky-600 py-3 rounded-xl font-bold text-xs">Sign Lease</button>
                            ` : `<div class="text-xs text-center text-slate-500 py-2">Lease ends: ${new Date(Number(rental.expiry) * 1000).toLocaleDateString()}</div>`}
                        </div>`;
                }
            } catch (e) { console.error(e); }
        }

        async function rentAsset(id) {
            const days = document.getElementById(`days-${id}`).value;
            if(!days) return;
            try {
                const rate = await contract.dailyRate();
                const tx = await contract.rentProperty(id, days, { value: rate * BigInt(days) });
                await tx.wait();
                loadGallery();
            } catch (e) { alert("Transaction Failed"); }
        }

        async function mintProperty() {
            const name = document.getElementById('pName').value;
            const img = document.getElementById('pImg').value;
            try {
                const tx = await contract.mintProperty(name, img);
                await tx.wait();
                loadGallery();
            } catch (e) { alert("Admin Error"); }
        }

        async function withdrawFunds() {
            try {
                const tx = await contract.withdraw();
                await tx.wait();
                alert("Withdrawal Complete");
            } catch (e) { alert("Action Restricted"); }
        }
    </script>
</body>
</html>
